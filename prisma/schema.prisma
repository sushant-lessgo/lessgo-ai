generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  clerkId   String    @unique
  email     String?
  projects  Project[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Project {
  id      String  @id @default(cuid())
  userId  String?
  user    User?   @relation(fields: [userId], references: [id])
  tokenId String  @unique
  token   Token   @relation(fields: [tokenId], references: [value])
  title   String  @default("Untitled Project")
  status  String  @default("draft")
  content Json?

  themeValues    Json?
  computedDesign Json?
  inputText      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Token {
  id        String   @id @default(cuid())
  value     String   @unique
  project   Project?
  createdAt DateTime @default(now())
}

model PublishedPage {
  id             String   @id @default(cuid())
  userId         String // Clerk User ID (external, not a foreign key)
  slug           String   @unique
  title          String?
  htmlContent    String
  content        Json?
  themeValues    Json?
  computedDesign Json?
  projectId      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isPublished    Boolean  @default(true)

  // Optional fields for future use
  previewImage String?
  views        Int     @default(0)

  // Static export fields (Phase 2)
  publishState     String   @default("draft") // draft, publishing, published, failed
  currentVersionId String?  @unique            // FK to PublishedPageVersion.id
  lastPublishAt    DateTime?
  publishError     String?
  analyticsEnabled Boolean  @default(false)

  // Relations
  currentVersion PublishedPageVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions       PublishedPageVersion[] @relation("PageVersions")

  @@index([userId])
}

model PublishedPageVersion {
  id              String   @id @default(cuid())
  publishedPageId String
  version         String // timestamp-nanoid: 20260107T123045789-a3k9xz
  blobKey         String // pages/{pageId}/{version}/index.html
  blobUrl         String
  sizeBytes       Int
  status          String   @default("active") // active, deleted
  createdAt       DateTime @default(now())

  publishedPage PublishedPage  @relation("PageVersions", fields: [publishedPageId], references: [id], onDelete: Cascade)
  currentFor    PublishedPage? @relation("CurrentVersion")

  @@unique([publishedPageId, version])
  @@index([publishedPageId])
  @@index([createdAt])
}

model TaxonomyEmbedding {
  id        String   @id @default(cuid())
  fieldType String // 'marketCategory', 'targetAudience', etc.
  value     String // The actual taxonomy value
  embedding Float[] // OpenAI embedding vector
  metadata  Json? // Additional info (group, description, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fieldType, value])
  @@index([fieldType])
}

model FormSubmission {
  id              String   @id @default(cuid())
  userId          String // Clerk User ID (owner of the form)
  publishedPageId String? // Optional - which published page the form was on
  formId          String // The MVP form ID from the store
  formName        String // Snapshot of form name at time of submission
  data            Json // The actual form submission data
  ipAddress       String? // Optional - visitor's IP
  userAgent       String? // Optional - visitor's browser
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([formId])
  @@index([publishedPageId])
}

model UserIntegration {
  id        String   @id @default(cuid())
  userId    String // Clerk User ID
  type      String // 'convertkit', 'mailchimp', etc.
  name      String // User-friendly name for the integration
  apiKey    String // Encrypted API key
  isActive  Boolean  @default(true)
  settings  Json? // Integration-specific settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, name])
  @@index([userId])
}

model PageAnalytics {
  id   String   @id @default(cuid())
  slug String // Published page slug
  date DateTime @db.Date

  // Core metrics (aggregated from PostHog)
  views           Int   @default(0)
  uniqueVisitors  Int   @default(0)
  formSubmissions Int   @default(0)
  conversionRate  Float @default(0) // Calculated: submissions/views

  // Engagement metrics
  avgTimeOnPage    Int? // Seconds
  medianTimeOnPage Int? // Seconds
  bounceRate       Float? // % who left without action
  ctaClicks        Int    @default(0)

  // Traffic sources (top 5 per day, JSON format)
  topReferrers  Json? // {"google.com": 234, "twitter.com": 156, ...}
  topUtmSources Json? // {"producthunt": 189, "twitter": 145, ...}

  // Device breakdown
  desktopViews Int @default(0)
  mobileViews  Int @default(0)
  tabletViews  Int @default(0)

  // Conversion by device
  desktopConversions Int @default(0)
  mobileConversions  Int @default(0)
  tabletConversions  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([slug, date])
  @@index([slug, date])
  @@index([date])
  @@index([slug])
}

model UserPlan {
  id     String @id @default(cuid())
  userId String @unique // Clerk User ID

  // Plan details
  tier   String @default("FREE") // FREE, PRO, AGENCY, ENTERPRISE
  status String @default("active") // active, trialing, cancelled, past_due, incomplete

  // Billing
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?

  // Trial tracking
  trialStart DateTime?
  trialEnd   DateTime?
  isTrialing Boolean   @default(false)

  // Credit limits
  creditsLimit Int @default(30)

  // Feature limits
  publishedPagesLimit  Int @default(1)
  draftProjectsLimit   Int @default(3)
  customDomainsLimit   Int @default(0)
  formSubmissionsLimit Int @default(100)
  teamMembersLimit     Int @default(1)

  // Features enabled
  removeBranding   Boolean @default(false)
  customDomains    Boolean @default(false)
  formIntegrations Boolean @default(false)
  exportHTML       Boolean @default(false)
  whiteLabel       Boolean @default(false)
  analytics        String  @default("none") // none, basic, full
  prioritySupport  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([tier])
  @@index([status])
}

model UserUsage {
  id     String @id @default(cuid())
  userId String
  period String // "2025-01" (YYYY-MM)

  // AI operation counts
  fullPageGens   Int @default(0)
  sectionRegens  Int @default(0)
  elementRegens  Int @default(0)
  fieldInference Int @default(0)

  // Token tracking (for analytics)
  totalTokens  Int @default(0)
  inputTokens  Int @default(0)
  outputTokens Int @default(0)

  // Credit system
  creditsUsed      Int @default(0)
  creditsLimit     Int @default(30)
  creditsRemaining Int @default(30)

  // Cost tracking (internal analytics)
  estimatedCost Float @default(0)

  // Published resource counts
  publishedPages  Int @default(0)
  draftProjects   Int @default(0)
  formSubmissions Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, period])
  @@index([userId])
  @@index([period])
}

model UsageEvent {
  id     String @id @default(cuid())
  userId String

  // Event details
  eventType     String // "page_generation", "section_regen", "element_regen", "field_inference"
  creditsUsed   Int
  tokensUsed    Int?
  estimatedCost Float?

  // Context
  projectId  String?
  sectionId  String?
  elementKey String?
  metadata   Json? // Store additional context

  // Request tracking
  endpoint     String?
  duration     Int? // milliseconds
  success      Boolean @default(true)
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType])
  @@index([createdAt])
  @@index([userId])
}
